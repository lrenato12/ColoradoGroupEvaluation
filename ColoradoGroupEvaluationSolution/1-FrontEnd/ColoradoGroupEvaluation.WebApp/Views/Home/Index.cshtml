@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="text-center">
    <h1 class="display-4">Controle de Clientes</h1>

    <a asp-action="Create" class="btn btn-outline-secondary me-md-2">Novo Cliente ></a>

    <div id="mainGrid"></div>

</div>

@section Scripts{
    <script>
        function GetBaseUrl() {
            return window.location.origin + '/';
        }

        //#region [ DOM CONTENT LOADED ]
        document.addEventListener("DOMContentLoaded", function () {
            LoadGrid();
        });
        //#endregion

        //#region [ LOAD GRID ]
        function LoadGrid() {
            const apiUrl = `${GetBaseUrl()}Home/GetAllCliente`;

            document.getElementById("mainGrid").innerHTML = "";

            new gridjs.Grid({
                columns: [
                    { id: 'codigoCliente', name: 'ID', hidden: true },
                    { id: 'razaoSocial', name: 'Razão Social' },
                    { id: 'nomeFantasia', name: 'Nome Fantasia' },
                    { id: 'documento', name: 'Documento' },
                    { id: 'endereco', name: 'Endereço' },
                    { id: 'uf', name: 'UF' },
                    {
                        name: 'Ações',
                        sort: false,
                        formatter: (cell, row) => {
                            const id = row.cells[0].data;
                            return gridjs.html(
                                `<button class="btn btn-danger btn-sm" onclick="ConfirmDelete(${id})">Excluir</button>`
                            );
                        }
                    }
                ],

                server: {
                    url: apiUrl,
                    then: data => {
                        if (data.apiResultData) {
                            return data.apiResultData.map(cliente => [
                                cliente.codigoCliente,
                                cliente.razaoSocial,
                                cliente.nomeFantasia,
                                cliente.documento,
                                cliente.endereco,
                                cliente.uf,
                                null
                            ]);
                        }
                        return [];
                    }
                },

                search: true,
                sort: true,
                pagination: {
                    limit: 10
                },

                language: {
                    'search': { 'placeholder': '🔍 Pesquisar...' },
                    'pagination': {
                        'previous': 'Anterior', 'next': 'Próximo', 'showing': 'Mostrando',
                        'results': () => 'resultados', 'to': 'a', 'of': 'de'
                    },
                    'loading': 'Carregando...',
                    'noRecordsFound': 'Nenhum registro encontrado',
                }

            }).render(document.getElementById("mainGrid"));
        }
        //#endregion

        //#region [ CONFIRM DELETE ]
        function ConfirmDelete(clienteId) {
            if (confirm("Tem certeza que deseja excluir este cliente?")) {
                const deleteUrl = `${GetBaseUrl()}Home/Delete/${clienteId}`;

                fetch(deleteUrl, {
                    method: 'GET'
                })
                    .then(response => {
                        debugger;

                        if (response.ok) {
                            alert("Cliente excluído com sucesso!");
                            LoadGrid();
                        } else {
                            response.text().then(text => alert("Erro ao excluir: " + text));
                        }
                    })
                    .catch(error => {
                        console.error("Erro na requisição de exclusão:", error);
                        alert("Ocorreu um erro de rede.");
                    });
            }
        }
        //#endregion
    </script>
}