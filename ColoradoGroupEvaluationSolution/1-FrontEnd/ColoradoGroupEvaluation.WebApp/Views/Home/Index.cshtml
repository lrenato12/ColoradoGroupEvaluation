@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="text-center">
    <h1 class="display-4">Controle de Clientes</h1>

    <a asp-action="Create" class="btn btn-outline-secondary me-md-2">Novo Cliente ></a>

    <div id="mainGrid"></div>
</div>

@section Scripts{
    <script>
        function GetBaseUrl() {
            return window.location.origin + '/';
        }

        //#region [ DOM CONTENT LOADED ]
        document.addEventListener("DOMContentLoaded", function () {
            LoadGrid();
        });
        //#endregion

        //#region [ LOAD GRID ]
        function LoadGrid() {
            const apiUrl = `${GetBaseUrl()}Home/GetAllCliente`;

            document.getElementById("mainGrid").innerHTML = "";

            new gridjs.Grid({
                columns: [
                    { id: 'codigoCliente', name: 'ID', hidden: true, className: 'truncate-cell' },
                    { id: 'razaoSocial', name: 'Razão Social', width: '250px', className: 'truncate-cell' },
                    { id: 'nomeFantasia', name: 'Nome Fantasia', width: '250px', className: 'truncate-cell' },
                    { id: 'documento', name: 'Documento', width: '250px', className: 'truncate-cell' },
                    { id: 'endereco', name: 'Endereço', width: '250px', className: 'truncate-cell' },
                    { id: 'bairro', name: 'Bairro', width: '250px', className: 'truncate-cell' },
                    { id: 'cidade', name: 'Cidade', width: '250px', className: 'truncate-cell' },
                    { id: 'uf', name: 'UF', width: '100px', className: 'truncate-cell' },
                    { id: 'cep', name: 'CEP', width: '150px', className: 'truncate-cell' },
                    { id: 'numeroTelefone', name: 'Telefone', width: '200px', className: 'truncate-cell' },
                    { id: 'operadora', name: 'Operadora', width: '200px', className: 'truncate-cell' },
                    { id: 'tipoPessoa', name: 'Tipo Pessoa', width: '150px', className: 'truncate-cell' },
                    {
                        name: 'Ações',
                        sort: false,
                        width: '200px',
                        className: 'truncate-cell',
                        formatter: (cell, row) => {
                            const id = row.cells[0].data;
                            const editUrl = `${GetBaseUrl()}Home/Edit/${id}`;

                            return gridjs.html(
                                `<a href="${editUrl}" class="btn btn-primary btn-sm me-1">Editar</a>` +
                                `<button class="btn btn-danger btn-sm" onclick="ConfirmDelete(${id})">Excluir</button>`
                            );
                        }
                    }
                ],

                server: {
                    url: apiUrl,
                    then: data => {
                        if (data.apiResultData) {
                            return data.apiResultData.map(cliente => [
                                cliente.codigoCliente,
                                cliente.razaoSocial,
                                cliente.nomeFantasia,
                                cliente.documento,
                                cliente.endereco,
                                cliente.bairro,
                                cliente.cidade,
                                cliente.uf,
                                cliente.cep,
                                cliente.numeroTelefone,
                                cliente.operadora,
                                cliente.tipoPessoa,
                                null
                            ]);
                        }
                        return [];
                    }
                },

                search: true,
                sort: true,
                pagination: {
                    limit: 10
                },

                language: {
                    'search': { 'placeholder': '🔍 Pesquisar...' },
                    'pagination': {
                        'previous': 'Anterior', 'next': 'Próximo', 'showing': 'Mostrando',
                        'results': () => 'resultados', 'to': 'a', 'of': 'de'
                    },
                    'loading': 'Carregando...',
                    'noRecordsFound': 'Nenhum registro encontrado',
                }

            }).render(document.getElementById("mainGrid"));
        }
        //#endregion

        //#region [ CONFIRM DELETE ]
        function ConfirmDelete(clienteId) {
            if (confirm("Tem certeza que deseja excluir este cliente?")) {
                const deleteUrl = `${GetBaseUrl()}Home/Delete/${clienteId}`;

                fetch(deleteUrl, {
                    method: 'GET'
                })
                    .then(response => {
                        if (response.ok) {
                            alert("Cliente excluído com sucesso!");
                            LoadGrid();
                        } else {
                            response.text().then(text => alert("Erro ao excluir: " + text));
                        }
                    })
                    .catch(error => {
                        console.error("Erro na requisição de exclusão:", error);
                        alert("Ocorreu um erro de rede.");
                    });
            }
        }
        //#endregion
    </script>
}